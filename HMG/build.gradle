import org.gradle.plugins.ide.eclipse.model.internal.FileReferenceFactory

// ===========================
// VERSION HANDLING (REAL BASE-10)
// ===========================

def versionFile = file('version.properties')

// defaults
int major = 2
int minor = 7
int revision = 0

if (versionFile.exists()) {
	def parts = versionFile.text.trim().tokenize('.')
	if (parts.size() != 3) {
		throw new GradleException("Invalid version format in version.properties")
	}
	major = parts[0].toInteger()
	minor = parts[1].toInteger()
	revision = parts[2].toInteger()
}

// increment like a normal number
revision++

if (revision == 10) {
	revision = 0
	minor++
}

if (minor == 10) {
	minor = 0
	major++
}

def newVersion = "${major}.${minor}.${revision}"
project.version = newVersion

task updateVersion {
	doLast {
		versionFile.text = newVersion
		println "Version bumped to $newVersion"
	}
}

// ===========================
// ECLIPSE CLASSPATH FIX
// ===========================

eclipse.classpath.file.whenMerged { cp ->
	def srcent = cp.entries.findAll {
		it.path.contains("codechicken") && it.path.endsWith("-src.jar")
	}

	cp.entries.removeAll(srcent)

	Map<String, File> srcmap = new HashMap<>()
	srcent.each {
		def file = new File(it.path)
		srcmap.put(file.name.replace("-src.jar", "-dev.jar"), file)
	}

	def fileref = new FileReferenceFactory()

	cp.entries.findAll {
		it.path.contains("codechicken") && it.path.endsWith("-dev.jar")
	}.each {
		File srcmapping = srcmap.get(new File(it.path).name)
		it.sourcePath = fileref.fromFile(srcmapping)
	}
}

// ===========================
// REPOSITORIES
// ===========================

repositories {
	maven {
		name = 'ModMaven'
		url = 'https://modmaven.dev'
	}
	maven {
		name = "gt"
		url = "https://gregtech.mechaenetia.com/"
	}
}

// ===========================
// DEPENDENCIES
// ===========================

dependencies {
	implementation 'codechicken:CodeChickenCore:1.7.10-1.0.4.29:dev'
	compileOnly   'codechicken:CodeChickenCore:1.7.10-1.0.4.29:src'

	implementation 'codechicken:CodeChickenLib:1.7.10-1.1.3.140:dev'
	compileOnly   'codechicken:CodeChickenLib:1.7.10-1.1.3.140:src'

	implementation 'codechicken:NotEnoughItems:1.7.10-1.0.3.74:dev'
	compileOnly   'codechicken:NotEnoughItems:1.7.10-1.0.3.74:src'

	compileOnly "inventorytweaks:InventoryTweaks:1.59-dev:deobf"
	implementation "li.cil.oc:OpenComputers:MC1.7.10-1.5.+:api"

	compile project(':depend')
	compile fileTree(dir: 'lib', include: '*.jar')
	compile 'javax.vecmath:vecmath:1.5.2'
}

// ===========================
// RESOURCE PROCESSING
// ===========================

processResources.dependsOn updateVersion

processResources {
	inputs.property "version", project.version

	filesMatching('mcmod.info') {
		expand version: project.version
	}
	from(sourceSets.main.resources.srcDirs) {
		include '**/*'
	}
}

// ===========================
// JAR CONFIG
// ===========================

jar {
	baseName = 'HandmadeGuns'
	version = project.version
}

// ===========================
// ENCODING FIX
// ===========================

tasks.withType(JavaCompile) {
	options.encoding = 'UTF-8'
}

// ===========================
// RUNCLIENT JVM FIX
// ===========================

tasks.withType(JavaExec) {
	if (name == "runClient") {
		jvmArgs "-Djinput.useDefaultPlugin=false"
		jvmArgs "-Djinput.plugins=none"
		jvmArgs "-Djinput.loglevel=OFF"
	}
}
